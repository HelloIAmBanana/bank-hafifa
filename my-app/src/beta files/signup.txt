import * as React from "react";
import { useForm, useFormState } from "react-hook-form";
import { useState, useEffect } from "react";
import FormHelperText from "@mui/material/FormHelperText";

import Ajv, { JSONSchemaType } from "ajv";
import Grid from "@mui/material/Grid";
import { Box, Button } from "@mui/material";
import CssBaseline from "@mui/material/CssBaseline";
import Paper from "@mui/material/Paper";
import AddAPhotoIcon from "@mui/icons-material/AddAPhoto";
import { Link } from "react-router-dom";
import { styled } from "@mui/material/styles";
import signupImage from "../../imgs/signupPage.svg";
import { resolve } from "path";

function getAsyncData(key: string) {
  const myPromise: Promise<string> = new Promise((resolve) => {
    setTimeout(() => {
      const data = localStorage.getItem(key);
      resolve(data ? JSON.parse(data) : []);
    }, 1000);
  });
  return myPromise;
}

function setAsyncData(key: string, value: UserData[]) {
  return new Promise((resolve) => {
    setTimeout(() => {
      localStorage.setItem(key, JSON.stringify(value));
      resolve(value);
    }, 1000);
  });
}

const ajv = new Ajv({ allErrors: true, $data: true });

const generateUniqueId = () => {
  return "_" + Math.random().toString(36).substr(2, 9);
};

const VisuallyHiddenInput = styled("input")({
  clip: "rect(0 0 0 0)",
  clipPath: "inset(50%)",
  height: 1,
  overflow: "hidden",
  position: "absolute",
  bottom: 0,
  left: 0,
  whiteSpace: "nowrap",
  width: 1,
});

type UserData = {
  id: string;
  firstName: string;
  lastName: string;
  birthDate: string;
  hobbies: string[];
  email: string;
  password: string;
  avatarUrl: string;
  gender: string;
  accountType: string;
  role: string;
};

const schema: JSONSchemaType<UserData> = {
  type: "object",
  properties: {
    id: { type: "string" },
    firstName: { type: "string", minLength: 1 },
    lastName: { type: "string", minLength: 1 },
    hobbies: { type: "array", items: { type: "string" } },
    email: { type: "string", pattern: "[a-z0-9._%+-]+@[a-z0-9.-]+.[a-z]{2,}$" },
    password: { type: "string", minLength: 6 },
    birthDate: { type: "string", minLength: 1 },
    avatarUrl: { type: "string" },
    gender: { type: "string", enum: ["male", "female"] },
    accountType: { type: "string", enum: ["business", "personal"] },
    role: { type: "string", enum: ["admin", "customer"] },
  },
  required: [
    "id",
    "accountType",
    "birthDate",
    "email",
    "firstName",
    "gender",
    "lastName",
    "password",
    "avatarUrl",
  ],
  additionalProperties: false,
};

const validate = ajv.compile(schema);

const SignUpPage: React.FC = () => {
  const [invalidEmail, setInvalidEmail] = useState("white");
  const [invalidPassword, setInvalidPassword] = useState("white");
  const [invalidFirstName, setInvalidFirstName] = useState("white");
  const [invalidLastName, setInvalidLastName] = useState("white");
  const [invalidDate, setInvalidDate] = useState("white");
  const {
    register,
    handleSubmit,
    setValue,
    formState: { errors },
  } = useForm<UserData>();
  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const imageUrl: string = URL.createObjectURL(file);
      console.log("Uploaded image URL:", imageUrl);
      setValue("avatarUrl", imageUrl);
    }
  };
  const onEmailChange = () => {
    setInvalidEmail("white");
  };
  const onDateChange = () => {
    setInvalidDate("white");
  };
  const onFirstNameChange = () => {
    setInvalidFirstName("white");
  };
  const onLastNameChange = () => {
    setInvalidLastName("white");
  };
  const onPasswordChange = () => {
    setInvalidPassword("white");
  };
  const onSubmit = async (data: UserData) => {
    data.id = generateUniqueId();
    data.role = "customer";
    data.email = data.email.toLowerCase();
    const isValid = validate(data);
    if (isValid) {
      const users = await getAsyncData("users");
      // async await Promise fullfill, rejected, pending
      const updatedUsers = Array.isArray(users) ? [...users, data] : [data];
      setAsyncData("users", updatedUsers).then(function () {
        window.location.href = "/signin";
      });
    } else {
      //        const errorMessage= (validate.errors==null?validate.errors:validate.errors[0].instancePath);
      console.log(validate.errors);
      const errorMessage = Array.isArray(validate.errors)
        ? validate.errors
        : [];
      console.log(errorMessage);
      for (let i = 0; i < errorMessage.length; i++) {
        if (errorMessage[i].instancePath == "/firstName") {
          setInvalidFirstName("red");
        }
        if (errorMessage[i].instancePath == "/lastName") {
          setInvalidLastName("red");
        }
        if (errorMessage[i].instancePath == "/email") {
          setInvalidEmail("red");
        }
        if (errorMessage[i].instancePath == "/password") {
          setInvalidPassword("red");
        }
        if (errorMessage[i].instancePath == "/birthDate") {
          setInvalidDate("red");
        }
      }
    }
  };

  return (
    <div
      style={{ boxShadow: "0px 4px 10px 0px #5a5354da", borderRadius: "15px" }}
    >
      <Grid container component="main" sx={{ height: "9" }}>
        <CssBaseline />
        <Grid
          item
          xs={false}
          sm={5}
          md={6}
          my={4.8}
          sx={{
            backgroundImage: `url(${signupImage})`,
            backgroundRepeat: "no-repeat",
            backgroundSize: "120%",
            backgroundPosition: "bottom left",
          }}
        />
        <Grid
          item
          xs={4}
          sm={6}
          md={5}
          component={Paper}
          elevation={8}
          square={false}
          borderRadius={5}
        >
          <Box
            sx={{
              my: 7,
              mx: 1,
              display: "flex",
              flexDirection: "column",
              alignItems: "center",
            }}
          ></Box>

          <Box
            component="form"
            onSubmit={handleSubmit(onSubmit)}
            sx={{ mt: 1 }}
          >
            <Grid container spacing={1}>
              {/*  */}
              <Grid item ml={12} my={-6}>
                <h1 className="firstTitle">CREATE ACCOUNT</h1>
              </Grid>
              <Grid item ml={12} sm={12} my={0}>
                <h2 className="secondTitle">
                  Welcome! Please fill out the details below
                </h2>
              </Grid>
              {/*  */}
              <Grid item mx={44} my={4} style={{ textAlign: "center" }}>
                <Button
                  style={{
                    fontSize: "2rem",
                    padding: "20px",
                    borderRadius: "50%",
                    backgroundColor: "#F1F1F1",
                  }}
                  component="label"
                >
                  <AddAPhotoIcon sx={{ color: "#212121" }} />
                  <VisuallyHiddenInput
                    type="file"
                    onChange={handleImageUpload}
                    required
                  />
                </Button>
              </Grid>
              <Grid item xl={12} my={-6} mx={35}>
                <h4 className="addAvatarText">Upload profile image</h4>
              </Grid>
              {/*  */}

              <Grid item ml={5} sm={2} mx={6} my={3}></Grid>
              <Grid item xs={8} sm={6} my={5} mx={-3}>
                <Grid item ml={5} mx={0}>
                  <h4 style={{ fontSize: 17 }}>First Name</h4>
                </Grid>
                <input
                  type="text"
                  {...register("firstName")}
                  placeholder="First Name"
                  onClick={onFirstNameChange}
                />
                <Grid my={-1} mx={12.5}>
                  <FormHelperText
                    id="component-error-text"
                    style={{
                      color: invalidFirstName,
                      fontFamily: "Poppins",
                      fontSize: "12px",
                    }}
                  >
                    Please enter your first name.
                  </FormHelperText>
                </Grid>
              </Grid>
              <Grid item ml={5} sm={2} mx={6} my={-6}></Grid>

              <Grid item xs={8} sm={6} my={-6} mx={-3}>
                <Grid item ml={5} mx={0} my={-2}>
                  <h4 style={{ fontSize: 17 }}>Last Name</h4>
                </Grid>

                <input
                  type="text"
                  {...register("lastName")}
                  placeholder="Last Name"
                  onClick={onLastNameChange}
                />
                <Grid my={-1} mx={12.5}>
                  <FormHelperText
                    id="component-error-text"
                    style={{
                      color: invalidLastName,
                      fontFamily: "Poppins",
                      fontSize: "12px",
                    }}
                  >
                    Please enter your last name.
                  </FormHelperText>
                </Grid>
              </Grid>
              <Grid item ml={5} sm={2} mx={6} my={5}></Grid>
              <Grid item xs={8} sm={6} my={5} mx={-3}>
                <Grid item ml={5} mx={0} my={-2}>
                  <h4 style={{ fontSize: 17 }}>Email</h4>
                </Grid>
                <input
                  id="email"
                  type="text"
                  {...register("email")}
                  placeholder="Email"
                  onClick={onEmailChange}
                />
                <Grid my={-1} mx={13.5}>
                  <FormHelperText
                    id="component-error-text"
                    style={{
                      color: invalidEmail,
                      fontFamily: "Poppins",
                      fontSize: "12px",
                    }}
                  >
                    Entered email is not valid.
                  </FormHelperText>
                </Grid>
              </Grid>
              <Grid item ml={5} sm={2} mx={6} my={-5}></Grid>
              <Grid item xs={8} sm={6} my={-5} mx={-3}>
                <Grid item ml={5} mx={0} my={-2}>
                  <h4 style={{ fontSize: 17 }}>Password</h4>
                </Grid>
                <input
                  type="password"
                  {...register("password")}
                  placeholder="Password"
                  onClick={onPasswordChange}
                />
                <Grid my={-1} mx={4.5}>
                  <FormHelperText
                    id="component-error-text"
                    style={{
                      color: invalidPassword,
                      fontFamily: "Poppins",
                      fontSize: "12px",
                    }}
                  >
                    Entered password is less than 6 characters.
                  </FormHelperText>
                </Grid>
              </Grid>
              <Grid item ml={5} sm={2} mx={6} my={1}></Grid>
              <Grid item xs={8} sm={6} my={3} mx={-3}>
                <Grid item ml={5} mx={0} my={-1}>
                  <h4 style={{ fontSize: 17 }}>Date Of Birth</h4>
                </Grid>
                <input
                  type="date"
                  onClick={onDateChange}
                  {...register("birthDate")}
                  placeholder="Birth Date"
                />
                <Grid my={-1} mx={15}>
                  <FormHelperText
                    id="component-error-text"
                    style={{
                      color: invalidDate,
                      fontFamily: "Poppins",
                      fontSize: "12px",
                    }}
                  >
                    Please enter a date.
                  </FormHelperText>
                </Grid>
              </Grid>
              <Grid item ml={5} sm={2} mx={6} my={-2}></Grid>
              <Grid item xs={8} sm={6} my={-5} mx={-3}>
                <Grid item ml={5} mx={0} my={-1}>
                  <h4 style={{ fontSize: 17 }}>Gender</h4>
                </Grid>
                <select {...register("gender")} required>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
              </Grid>
              <Grid item ml={5} sm={2} mx={6} my={1}></Grid>
              <Grid item xs={8} sm={6} my={3} mx={-3}>
                <Grid item ml={5} mx={0} my={-1}>
                  <h4 style={{ fontSize: 16 }}>Account Type</h4>
                </Grid>
                <select {...register("accountType")} required>
                  <option value="business">Business</option>
                  <option value="personal">Personal</option>
                </select>
              </Grid>
              <Grid item ml={12} my={-3} mx={42}>
                <button type="submit" className="submitButton">
                  Register
                </button>
              </Grid>
              <Grid container justifyContent="flex-start">
                <Grid item mx={7} my={1}>
                  <Link to="/signin" className="existingUserButton">
                    Already got a user?
                  </Link>
                </Grid>
              </Grid>
            </Grid>
          </Box>
        </Grid>
      </Grid>
    </div>
  );
};

export default SignUpPage;
